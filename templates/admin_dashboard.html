<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/static/admin.css">
</head>
<body>
    <div class="admin-container">
        <h1>Admin Dashboard</h1>
        
        <h2>Create New Event</h2>
        <form action="{{ url_for('new_event') }}" method="POST">
            <label for="name">Event Name:</label>
            <input type="text" id="name" name="name" required>
            <div id="nameValidation" class="validation-message" style="display: none;"></div>

            <div class="slug-preview">
                <small>URL will be: <strong>partymail.app/<input type="text" id="slugPreview" name="slug" class="slug-input" required></strong></small>
                <button type="button" id="autoGenerateSlug" class="slug-auto-btn">↻ Auto</button>
            </div>
            <div id="slugValidation" class="validation-message" style="display: none;"></div>

            <label for="date">Date:</label>
            <input type="text" id="date" name="date" required>
            <small class="help-text">Use one of these formats: November 15, 2024 | 2024-11-15 | 11/15/2024</small>
            
            <label for="start_time">Start Time:</label>
            <input type="text" id="start_time" name="start_time" required>
            <small class="help-text">Use one of these formats: 7:00 PM | 19:00 | 7:30 AM</small>

            <label for="end_time">End Time (optional):</label>
            <input type="text" id="end_time" name="end_time">
            <small class="help-text">Leave blank if no specific end time</small>
            
            <label for="location">Location:</label>
            <input type="text" id="location" name="location" required>
            
            <label for="description">Description:</label>
            <textarea id="description" name="description" required></textarea>
            
            <label for="max_guests_per_invite">Max Guests per Invite:</label>
            <input type="number" id="max_guests_per_invite" name="max_guests_per_invite" required>
            
            <button type="submit">Create Event</button>
        </form>

        <h2>Existing Events</h2>
        <ul>
            {% for slug, event in events.items() %}
                <li><a href="{{ url_for('admin', slug=event['slug']) }}">{{ event['name'] }} ({{ slug }})</a></li>
            {% endfor %}
        </ul>
        <a href="{{ url_for('passkey.admin_settings') }}" class="button" style="background-color:#0066cc;margin-right:10px">Settings</a>
        <a href="{{ url_for('admin_logout') }}">Logout</a>
    </div>

    <script>
        // Existing event names and slugs for validation
        const existingEventNames = [
            {% for slug, event in events.items() %}
                "{{ event['name'] | lower }}",
            {% endfor %}
        ];

        const existingSlugs = [
            {% for slug, event in events.items() %}
                "{{ slug }}",
            {% endfor %}
        ];

        // Generate slug preview as user types
        function generateSlug(name) {
            // Convert to lowercase
            let slug = name.toLowerCase();

            // Remove accents (basic ASCII conversion)
            slug = slug.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

            // Remove non-alphanumeric characters (keep spaces and hyphens)
            slug = slug.replace(/[^\w\s-]/g, '');

            // Replace multiple spaces/hyphens with single hyphen
            slug = slug.replace(/[-\s]+/g, '-');

            // Remove leading/trailing hyphens
            slug = slug.replace(/^-+|-+$/g, '');

            return slug;
        }

        // Validate slug format (alphanumeric and hyphens only)
        function isValidSlugFormat(slug) {
            // Must contain only lowercase letters, numbers, and hyphens
            // Cannot start or end with a hyphen
            return /^[a-z0-9]+(-[a-z0-9]+)*$/.test(slug);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('name');
            const slugInput = document.getElementById('slugPreview');
            const nameValidation = document.getElementById('nameValidation');
            const slugValidation = document.getElementById('slugValidation');
            const submitButton = document.querySelector('button[type="submit"]');
            const autoGenerateButton = document.getElementById('autoGenerateSlug');

            let manualSlugEdit = false;

            // Auto-generate slug from name
            function updateSlugFromName() {
                const name = nameInput.value.trim();
                const slug = generateSlug(name);
                slugInput.value = slug || '';
                validateSlug(slug);
            }

            // Validate slug
            function validateSlug(slug) {
                if (!slug) {
                    slugValidation.textContent = '';
                    slugValidation.style.display = 'none';
                    slugInput.classList.remove('invalid');
                    submitButton.disabled = true;
                    return false;
                }

                // Check format
                if (!isValidSlugFormat(slug)) {
                    slugValidation.textContent = '⚠️ Slug must contain only lowercase letters, numbers, and hyphens (no spaces, no special characters)';
                    slugValidation.style.display = 'block';
                    slugValidation.className = 'validation-message error';
                    slugInput.classList.add('invalid');
                    submitButton.disabled = true;
                    return false;
                }

                // Check for duplicates
                if (existingSlugs.includes(slug)) {
                    slugValidation.textContent = '⚠️ This slug is already in use';
                    slugValidation.style.display = 'block';
                    slugValidation.className = 'validation-message error';
                    slugInput.classList.add('invalid');
                    submitButton.disabled = true;
                    return false;
                }

                // Check length
                if (slug.length > 50) {
                    slugValidation.textContent = '⚠️ Slug is too long (max 50 characters)';
                    slugValidation.style.display = 'block';
                    slugValidation.className = 'validation-message error';
                    slugInput.classList.add('invalid');
                    submitButton.disabled = true;
                    return false;
                }

                // All good
                slugValidation.textContent = '✓ Slug is valid';
                slugValidation.style.display = 'block';
                slugValidation.className = 'validation-message success';
                slugInput.classList.remove('invalid');
                return true;
            }

            // Validate name
            function validateName() {
                const name = nameInput.value.trim();

                // Check for empty name
                if (name === '') {
                    nameValidation.textContent = '';
                    nameValidation.style.display = 'none';
                    submitButton.disabled = true;
                    return false;
                }
                // Check for duplicate names
                else if (existingEventNames.includes(name.toLowerCase())) {
                    nameValidation.textContent = '⚠️ An event with this name already exists';
                    nameValidation.style.display = 'block';
                    nameValidation.className = 'validation-message error';
                    submitButton.disabled = true;
                    return false;
                } else {
                    nameValidation.textContent = '✓ Event name is available';
                    nameValidation.style.display = 'block';
                    nameValidation.className = 'validation-message success';
                    return true;
                }
            }

            // Update submit button state
            function updateSubmitButton() {
                const nameValid = validateName();
                const slugValid = validateSlug(slugInput.value);
                submitButton.disabled = !(nameValid && slugValid);
            }

            // Name input handler
            nameInput.addEventListener('input', function() {
                validateName();

                // Auto-generate slug if not manually edited
                if (!manualSlugEdit) {
                    updateSlugFromName();
                }

                updateSubmitButton();
            });

            // Slug input handler
            slugInput.addEventListener('input', function() {
                manualSlugEdit = true;
                validateSlug(this.value);
                updateSubmitButton();
            });

            // Auto-generate button handler
            autoGenerateButton.addEventListener('click', function() {
                manualSlugEdit = false;
                updateSlugFromName();
                updateSubmitButton();
            });

            // Initialize
            updateSubmitButton();
        });
    </script>
</body>
</html>